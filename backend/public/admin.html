<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pegasus Admin - Solicita√ß√µes de Integra√ß√£o</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: #1a1a1a;
            color: #ffffff;
            min-height: 100vh;
        }

        /* Sidebar */
        .sidebar {
            position: fixed;
            left: 0;
            top: 0;
            width: 280px;
            height: 100vh;
            background: rgba(255, 255, 255, 0.03);
            backdrop-filter: blur(20px);
            border-right: 1px solid rgba(255, 255, 255, 0.1);
            padding: 30px 20px;
            overflow-y: auto;
        }

        .logo-container {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 40px;
            padding-bottom: 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .logo {
            width: 50px;
            height: 50px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }

        .logo img {
            width: 100%;
            height: 100%;
            object-fit: contain;
            mix-blend-mode: lighten;
            filter: brightness(1.2) contrast(1.1);
        }

        .logo-text {
            font-size: 18px;
            font-weight: 600;
            color: #b5a472;
        }

        .nav-item {
            padding: 14px 16px;
            margin-bottom: 8px;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 12px;
            color: #999;
        }

        .nav-item:hover {
            background: rgba(181, 164, 114, 0.1);
            color: #b5a472;
        }

        .nav-item.active {
            background: rgba(181, 164, 114, 0.15);
            color: #b5a472;
            font-weight: 500;
        }

        .badge {
            margin-left: auto;
            background: #ef4444;
            color: white;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 12px;
            font-weight: 600;
        }

        /* Main Content */
        .main-content {
            margin-left: 280px;
            padding: 30px;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            flex-wrap: wrap;
            gap: 20px;
        }

        h1 {
            font-size: 32px;
            background: linear-gradient(135deg, #b5a472 0%, #d4c896 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .header-actions {
            display: flex;
            gap: 12px;
        }

        .btn {
            padding: 12px 24px;
            border-radius: 10px;
            border: none;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #b5a472 0%, #d4c896 100%);
            color: #1a1a1a;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(181, 164, 114, 0.3);
        }

        .btn-secondary {
            background: rgba(255, 255, 255, 0.05);
            color: #ccc;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .btn-secondary:hover {
            background: rgba(255, 255, 255, 0.08);
        }

        /* Stats Cards */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 16px;
            padding: 24px;
            transition: all 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
        }

        .stat-icon {
            width: 50px;
            height: 50px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            margin-bottom: 16px;
        }

        .stat-value {
            font-size: 32px;
            font-weight: 700;
            margin-bottom: 8px;
        }

        .stat-label {
            font-size: 14px;
            color: #999;
        }

        /* Filters */
        .filters {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 20px;
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            align-items: center;
        }

        .filter-item {
            flex: 1;
            min-width: 200px;
        }

        .filter-item label {
            display: block;
            font-size: 13px;
            color: #999;
            margin-bottom: 6px;
        }

        .filter-item select,
        .filter-item input {
            width: 100%;
            padding: 10px 14px;
            background: #0f0f0f;
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            color: #ffffff;
            font-size: 14px;
        }

        .filter-item select option {
            background: #0f0f0f;
            color: #ffffff;
        }

        /* Table */
        .table-container {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 16px;
            overflow: hidden;
        }

        .section-card {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .section-card h3 {
            font-size: 16px;
            color: #b5a472;
            margin-bottom: 12px;
        }

        .section-table {
            width: 100%;
            border-collapse: collapse;
        }

        .section-table th,
        .section-table td {
            padding: 12px 10px;
            text-align: left;
            border-top: 1px solid rgba(255, 255, 255, 0.08);
            font-size: 13px;
        }

        .section-table th {
            color: #b5a472;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.4px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        thead {
            background: rgba(181, 164, 114, 0.1);
        }

        th {
            padding: 16px;
            text-align: left;
            font-size: 13px;
            font-weight: 600;
            color: #b5a472;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        td {
            padding: 16px;
            border-top: 1px solid rgba(255, 255, 255, 0.05);
        }

        tbody tr {
            transition: all 0.2s ease;
        }

        tbody tr:hover {
            background: rgba(255, 255, 255, 0.03);
        }

        .status-badge {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            display: inline-block;
        }

        .status-pending {
            background: rgba(251, 191, 36, 0.2);
            color: #fbbf24;
        }

        .status-analyzing {
            background: rgba(59, 130, 246, 0.2);
            color: #3b82f6;
        }

        .status-approved {
            background: rgba(74, 222, 128, 0.2);
            color: #4ade80;
        }

        .status-rejected {
            background: rgba(239, 68, 68, 0.2);
            color: #ef4444;
        }

        .action-buttons {
            display: flex;
            gap: 8px;
        }

        .btn-icon {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            font-size: 14px;
        }

        .btn-view {
            background: rgba(59, 130, 246, 0.2);
            color: #3b82f6;
        }

        .btn-view:hover {
            background: rgba(59, 130, 246, 0.3);
        }

        .btn-approve {
            background: rgba(74, 222, 128, 0.2);
            color: #4ade80;
        }

        .btn-approve:hover {
            background: rgba(74, 222, 128, 0.3);
        }

        .btn-reject {
            background: rgba(239, 68, 68, 0.2);
            color: #ef4444;
        }

        .btn-reject:hover {
            background: rgba(239, 68, 68, 0.3);
        }

        .gateway-info {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .gateway-logo {
            width: 40px;
            height: 40px;
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.1);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
        }

        .gateway-details h4 {
            font-size: 14px;
            margin-bottom: 4px;
        }

        .gateway-details p {
            font-size: 12px;
            color: #999;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(10px);
            z-index: 1000;
            padding: 20px;
            overflow-y: auto;
        }

        .modal.show {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: #1a1a1a;
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            padding: 40px;
            max-width: 800px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-actions {
            margin-top: 20px;
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }

        .modal-error {
            color: #ff6b6b;
            font-size: 13px;
            margin-top: 8px;
        }

        .modal .form-group {
            margin-bottom: 16px;
        }

        .modal .form-group label {
            display: block;
            font-size: 13px;
            color: #cfcfcf;
            margin-bottom: 8px;
        }

        .modal .form-group select,
        .modal .form-group textarea,
        .modal .form-group input {
            width: 100%;
            padding: 10px 12px;
            background: #0f0f0f;
            border: 1px solid rgba(255, 255, 255, 0.12);
            border-radius: 8px;
            color: #ffffff;
            font-size: 14px;
        }

        .modal .form-group select option {
            background: #0f0f0f;
            color: #ffffff;
        }

        .modal .form-group textarea {
            min-height: 90px;
            resize: vertical;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
        }

        .modal-header h2 {
            font-size: 24px;
            color: #b5a472;
        }

        .close-btn {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            border: none;
            background: rgba(255, 255, 255, 0.05);
            color: #999;
            cursor: pointer;
            font-size: 20px;
            transition: all 0.2s ease;
        }

        .close-btn:hover {
            background: rgba(255, 255, 255, 0.1);
            color: #fff;
        }

        .detail-section {
            margin-bottom: 30px;
        }

        .detail-section h3 {
            font-size: 16px;
            color: #b5a472;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .detail-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
        }

        .detail-item {
            background: rgba(255, 255, 255, 0.03);
            padding: 15px;
            border-radius: 10px;
        }

        .detail-label {
            font-size: 12px;
            color: #999;
            margin-bottom: 6px;
        }

        .detail-value {
            font-size: 14px;
            color: #fff;
        }

        .payment-methods {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 10px;
        }

        .payment-badge {
            padding: 6px 12px;
            background: rgba(181, 164, 114, 0.2);
            color: #b5a472;
            border-radius: 6px;
            font-size: 12px;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #999;
        }

        .empty-state-icon {
            font-size: 64px;
            margin-bottom: 20px;
        }

        @media (max-width: 1024px) {
            .sidebar {
                width: 70px;
                padding: 20px 10px;
            }

            .logo-text,
            .nav-item span:not(.badge) {
                display: none;
            }

            .main-content {
                margin-left: 70px;
            }
        }

        @media (max-width: 768px) {
            .sidebar {
                display: none;
            }

            .main-content {
                margin-left: 0;
                padding: 20px;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }

            .filters {
                flex-direction: column;
            }

            .filter-item {
                width: 100%;
            }

            .table-container {
                overflow-x: auto;
            }

            table {
                min-width: 800px;
            }
        }
    </style>
</head>
<body>
    <!-- Sidebar -->
    <div class="sidebar">
        <div class="logo-container">
            <div class="logo">
                <img src="/pegasus-logo.jpg" alt="Pegasus Logo">
            </div>
            <div class="logo-text">Pegasus Admin</div>
        </div>

        <div class="nav-item active" data-view="solicitacoes" onclick="setView('solicitacoes', this)">
            <span>üìã</span>
            <span>Solicita√ß√µes</span>
            <span class="badge" id="pendingCount">0</span>
        </div>
        <div class="nav-item" data-view="aguardando" onclick="setView('aguardando', this)">
            <span>‚è≥</span>
            <span>Aguardando</span>
        </div>
        <div class="nav-item" data-view="integrando" onclick="setView('integrando', this)">
            <span>üõ†Ô∏è</span>
            <span>Integrando</span>
        </div>
        <div class="nav-item" data-view="concluido" onclick="setView('concluido', this)">
            <span>‚úÖ</span>
            <span>Conclu√≠do</span>
        </div>
        <div class="nav-item" data-view="rejeitado" onclick="setView('rejeitado', this)">
            <span>‚ùå</span>
            <span>Rejeitadas</span>
        </div>
        <div class="nav-item" data-view="stats" onclick="setView('stats', this)">
            <span>üìä</span>
            <span>Estat√≠sticas</span>
        </div>
        <div class="nav-item" data-view="settings" onclick="setView('settings', this)">
            <span>‚öôÔ∏è</span>
            <span>Configura√ß√µes</span>
        </div>
    </div>

    <!-- Main Content -->
    <div class="main-content">
        <div class="header">
            <div>
                <h1>Solicita√ß√µes de Integra√ß√£o</h1>
                <p style="color: #999; margin-top: 8px;">Gerencie as solicita√ß√µes de integra√ß√£o de gateways</p>
            </div>
            <div class="header-actions">
                <button class="btn btn-secondary" onclick="exportData()">
                    <span>üì•</span>
                    Exportar
                </button>
                <button class="btn btn-primary" onclick="refreshData()">
                    <span>üîÑ</span>
                    Atualizar
                </button>
            </div>
        </div>

        <!-- Stats -->
        <div class="stats-grid" id="statsGrid"></div>

        <!-- Filters -->
        <div class="filters" id="filtersContainer"></div>

        <div id="customContent" style="display: none;"></div>

        <!-- Table -->
        <div class="table-container" id="tableContainer">
            <table>
                <thead id="tableHead"></thead>
                <tbody id="tableBody"></tbody>
            </table>
            <div id="emptyState" class="empty-state" style="display: none;">
                <div class="empty-state-icon">üì≠</div>
                <h3>Nenhuma solicita√ß√£o encontrada</h3>
                <p>Quando houver novas solicita√ß√µes, elas aparecer√£o aqui.</p>
            </div>
        </div>
    </div>

    <!-- Modal -->
    <div class="modal" id="detailModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Detalhes da Solicita√ß√£o</h2>
                <button class="close-btn" onclick="closeModal()">‚úï</button>
            </div>
            <div id="modalBody">
                <!-- Details will be inserted here -->
            </div>
        </div>
    </div>

    <div class="modal" id="messageModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="messageModalTitle">Mensagem</h2>
                <button class="close-btn" onclick="closeMessageModal()">‚úï</button>
            </div>
            <div id="messageModalBody"></div>
            <div class="modal-actions" id="messageModalActions"></div>
        </div>
    </div>

    <script>
        window.API_URL = window.API_URL || `${window.location.origin}/api`;
    </script>
    <script>
        function escapeHtml(text) {
            if (!text) return '';
            const map = {
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#039;'
            };
            return String(text).replace(/[&<>"']/g, m => map[m]);
        }

        function formatStatus(status) {
            const map = {
                Pendente: 'Pendente',
                Aguardando: 'Aguardando',
                Integrando: 'Integrando',
                Concluido: 'Conclu√≠do',
                Rejeitado: 'Rejeitado'
            };
            return map[status] || status;
        }

        const useMockData = false; // Consumir API real.
        let allRequests = [];
        let currentView = 'solicitacoes';
        let currentFilters = {};

        const getApiBase = () => {
            const hostname = window.location.hostname;
            if (hostname === 'localhost' || hostname === '127.0.0.1') {
                return 'http://localhost:3333/api';
            }
            return `${window.location.origin}/api`;
        };
        const apiBase = window.API_URL || getApiBase();

        const mockData = [
            {
                id: 'REQ-20260209-00001',
                gatewayName: 'Mercado Pago',
                whitelabelName: 'Zenith Pay',
                clientName: 'Zenith Global',
                responsibleName: 'Ana Costa',
                responsibleEmail: 'ana@zenith.com',
                developerName: 'Lucas M.',
                developerEmail: 'lucas@zenith.com',
                status: 'Pendente',
                createdAt: '2026-02-08T10:10:00Z',
                waitingReason: 'aprovacao',
                slaLimit: '2026-02-12T10:10:00Z',
                stage: 'Backlog',
                environment: 'Sandbox',
                lastEvent: 'Formul√°rio enviado',
                integrationType: 'API',
                rejectionReason: '',
                decisionBy: '',
                integrandoAt: null,
                concluidoAt: null,
                slaMet: false
            },
            {
                id: 'REQ-20260209-00002',
                gatewayName: 'PagSeguro',
                whitelabelName: 'Pegasus',
                clientName: 'Pegasus Checkout',
                responsibleName: 'Bruno Lima',
                responsibleEmail: 'bruno@pegasus.com',
                developerName: 'Marina S.',
                developerEmail: 'marina@pegasus.com',
                status: 'Aguardando',
                createdAt: '2026-02-07T09:00:00Z',
                waitingReason: 'documentacao',
                slaLimit: '2026-02-11T09:00:00Z',
                stage: 'Triagem',
                environment: 'Sandbox',
                lastEvent: 'Documenta√ß√£o pendente',
                integrationType: 'API',
                rejectionReason: '',
                decisionBy: '',
                integrandoAt: null,
                concluidoAt: null,
                slaMet: false
            },
            {
                id: 'REQ-20260209-00003',
                gatewayName: 'Stripe',
                whitelabelName: 'Nova Bank',
                clientName: 'Nova Bank',
                responsibleName: 'Carla F.',
                responsibleEmail: 'carla@novabank.com',
                developerName: 'Rafael A.',
                developerEmail: 'rafael@novabank.com',
                status: 'Integrando',
                createdAt: '2026-02-06T12:30:00Z',
                waitingReason: 'cliente',
                slaLimit: '2026-02-10T12:30:00Z',
                stage: 'Homologacao',
                environment: 'Sandbox',
                lastEvent: 'Teste de webhook',
                integrationType: 'SDK',
                rejectionReason: '',
                decisionBy: '',
                integrandoAt: '2026-02-07T08:00:00Z',
                concluidoAt: null,
                slaMet: false
            },
            {
                id: 'REQ-20260209-00004',
                gatewayName: 'Adyen',
                whitelabelName: 'AlphaPay',
                clientName: 'AlphaPay',
                responsibleName: 'Diego P.',
                responsibleEmail: 'diego@alphapay.com',
                developerName: 'Fernanda C.',
                developerEmail: 'fernanda@alphapay.com',
                status: 'Concluido',
                createdAt: '2026-02-01T11:00:00Z',
                waitingReason: '',
                slaLimit: '2026-02-07T11:00:00Z',
                stage: 'Producao',
                environment: 'Producao',
                lastEvent: 'Go-live',
                integrationType: 'API',
                rejectionReason: '',
                decisionBy: '',
                integrandoAt: '2026-02-02T10:00:00Z',
                concluidoAt: '2026-02-06T18:00:00Z',
                slaMet: true
            },
            {
                id: 'REQ-20260209-00005',
                gatewayName: 'Pagar.me',
                whitelabelName: 'Vulcan',
                clientName: 'Vulcan SA',
                responsibleName: 'Eduardo R.',
                responsibleEmail: 'eduardo@vulcan.com',
                developerName: 'Joana V.',
                developerEmail: 'joana@vulcan.com',
                status: 'Rejeitado',
                createdAt: '2026-02-03T14:40:00Z',
                waitingReason: '',
                slaLimit: '2026-02-08T14:40:00Z',
                stage: 'Rejeitado',
                environment: 'Sandbox',
                lastEvent: 'Rejei√ß√£o por documenta√ß√£o',
                integrationType: 'API',
                rejectionReason: 'documentacao',
                decisionBy: 'Comit√™ T√©cnico',
                integrandoAt: null,
                concluidoAt: null,
                slaMet: false
            },
            {
                id: 'REQ-20260209-00006',
                gatewayName: 'Mercado Pago',
                whitelabelName: 'Aurora',
                clientName: 'Aurora Labs',
                responsibleName: 'Iara S.',
                responsibleEmail: 'iara@aurora.com',
                developerName: 'Thiago L.',
                developerEmail: 'thiago@aurora.com',
                status: 'Integrando',
                createdAt: '2026-02-05T09:15:00Z',
                waitingReason: '',
                slaLimit: '2026-02-12T09:15:00Z',
                stage: 'Teste',
                environment: 'Sandbox',
                lastEvent: 'Erro em assinatura',
                integrationType: 'API',
                rejectionReason: '',
                decisionBy: '',
                integrandoAt: '2026-02-05T12:00:00Z',
                concluidoAt: null,
                slaMet: false
            }
        ];

        const settingsData = {
            statuses: ['Pendente', 'Aguardando', 'Integrando', 'Concluido', 'Rejeitado'],
            rejectionReasons: ['documentacao', 'tecnica', 'compliance', 'pagamento'],
            slas: [
                { tipo: 'API', horas: 96 },
                { tipo: 'SDK', horas: 72 }
            ],
            roles: ['Admin', 'Opera√ß√µes', 'Tech Lead'],
            templates: ['Email Aprova√ß√£o', 'Email Rejei√ß√£o', 'Solicitar Docs']
        };

        const viewConfigs = {
            solicitacoes: {
                title: 'Solicita√ß√µes de Integra√ß√£o',
                subtitle: 'Vis√£o geral do pipeline de integra√ß√µes',
                defaultStatus: '',
                cards: (data) => [
                    { label: 'Total', value: data.length, icon: 'üìå' },
                    { label: 'Pendentes', value: data.filter(d => d.status === 'Pendente').length, icon: '‚è≥' },
                    { label: 'Integrando', value: data.filter(d => d.status === 'Integrando').length, icon: 'üõ†Ô∏è' },
                    { label: 'Conclu√≠dos', value: data.filter(d => d.status === 'Concluido').length, icon: '‚úÖ' },
                    { label: 'Rejeitados', value: data.filter(d => d.status === 'Rejeitado').length, icon: '‚ùå' }
                ],
                filters: [
                    { id: 'status', label: 'Status', type: 'select', options: ['', 'Pendente', 'Aguardando', 'Integrando', 'Concluido', 'Rejeitado'] },
                    { id: 'search', label: 'Buscar', type: 'text', placeholder: 'Gateway, cliente, respons√°vel...' },
                    { id: 'date', label: 'Data', type: 'date' }
                ],
                columns: [
                    { label: 'ID', render: (r) => `<strong>${escapeHtml(r.id)}</strong>` },
                    { label: 'Gateway', render: (r) => `
                        <div class="gateway-info">
                            <div class="gateway-logo">üí≥</div>
                            <div class="gateway-details">
                                <h4>${escapeHtml(r.gatewayName)}</h4>
                                <p>${escapeHtml(r.whitelabelName)}</p>
                            </div>
                        </div>
                    ` },
                    { label: 'Cliente/Parceiro', render: (r) => escapeHtml(r.clientName || r.whitelabelName || '-') },
                    { label: 'Respons√°vel t√©cnico', render: (r) => escapeHtml(r.responsibleName) },
                    { label: 'Desenvolvedor', render: (r) => escapeHtml(r.developerName) },
                    { label: 'Data', render: (r) => formatDate(r.createdAt) },
                    { label: 'Status', render: (r) => renderStatus(r.status) },
                    { label: 'A√ß√µes', render: (r) => renderActions(r) }
                ],
                empty: { title: 'Nenhuma solicita√ß√£o encontrada', text: 'Quando houver novas solicita√ß√µes, elas aparecer√£o aqui.' }
            },
            aguardando: {
                title: 'Aguardando',
                subtitle: 'Fila de integra√ß√µes aguardando pr√≥xima a√ß√£o',
                defaultStatus: 'Aguardando',
                cards: (data) => [
                    { label: 'Aguardando', value: data.length, icon: '‚è≥' },
                    { label: 'SLA em risco', value: data.filter(d => isSlaRisk(d.slaLimit)).length, icon: '‚ö†Ô∏è' },
                    { label: 'Aguardando documenta√ß√£o', value: data.filter(d => d.waitingReason === 'documentacao').length, icon: 'üìÑ' },
                    { label: 'Aguardando aprova√ß√£o', value: data.filter(d => d.waitingReason === 'aprovacao').length, icon: '‚úÖ' }
                ],
                filters: [
                    { id: 'motivo', label: 'Motivo', type: 'select', options: ['', 'documentacao', 'aprovacao', 'cliente'] },
                    { id: 'gateway', label: 'Gateway', type: 'text', placeholder: 'Nome do gateway' },
                    { id: 'search', label: 'Buscar', type: 'text', placeholder: 'Cliente, respons√°vel...' },
                    { id: 'date', label: 'Data', type: 'date' }
                ],
                columns: [
                    { label: 'ID', render: (r) => `<strong>${escapeHtml(r.id)}</strong>` },
                    { label: 'Gateway', render: (r) => escapeHtml(r.gatewayName) },
                    { label: 'Cliente', render: (r) => escapeHtml(r.clientName || r.whitelabelName || '-') },
                    { label: 'Motivo', render: (r) => escapeHtml(r.waitingReason || '-') },
                    { label: 'SLA limite', render: (r) => formatDate(r.slaLimit) },
                    { label: 'Respons√°vel', render: (r) => escapeHtml(r.responsibleName) },
                    { label: 'Data', render: (r) => formatDate(r.createdAt) },
                    { label: 'A√ß√µes', render: (r) => `
                        <div class="action-buttons">
                            <button class="btn-icon btn-approve" onclick="updateStatus('${r.id}', 'Integrando')" title="Iniciar Integra√ß√£o">üõ†Ô∏è</button>
                            <button class="btn-icon btn-reject" onclick="requestAdjustment('${r.id}')" title="Solicitar Ajuste">‚úèÔ∏è</button>
                        </div>
                    ` }
                ],
                empty: { title: 'Nenhuma fila pendente', text: 'Nenhuma integra√ß√£o aguardando a√ß√£o no momento.' }
            },
            integrando: {
                title: 'Integrando',
                subtitle: 'Acompanhamento de integra√ß√µes em execu√ß√£o',
                defaultStatus: 'Integrando',
                cards: (data) => [
                    { label: 'Em andamento', value: data.length, icon: 'üõ†Ô∏è' },
                    { label: 'Bloqueadas', value: data.filter(d => d.stage === 'Bloqueada').length, icon: '‚õî' },
                    { label: 'Em teste', value: data.filter(d => d.stage === 'Teste').length, icon: 'üß™' },
                    { label: 'Em homologa√ß√£o', value: data.filter(d => d.stage === 'Homologacao').length, icon: '‚úÖ' }
                ],
                filters: [
                    { id: 'etapa', label: 'Etapa', type: 'select', options: ['', 'Backlog', 'Teste', 'Homologacao', 'Bloqueada'] },
                    { id: 'dev', label: 'Desenvolvedor', type: 'text', placeholder: 'Nome do dev' },
                    { id: 'gateway', label: 'Gateway', type: 'text', placeholder: 'Nome do gateway' },
                    { id: 'ambiente', label: 'Ambiente', type: 'select', options: ['', 'Sandbox', 'Producao'] }
                ],
                columns: [
                    { label: 'ID', render: (r) => `<strong>${escapeHtml(r.id)}</strong>` },
                    { label: 'Gateway', render: (r) => escapeHtml(r.gatewayName) },
                    { label: 'Cliente', render: (r) => escapeHtml(r.clientName || r.whitelabelName || '-') },
                    { label: 'Ambiente', render: (r) => escapeHtml(r.environment || '-') },
                    { label: 'Etapa', render: (r) => escapeHtml(r.stage || '-') },
                    { label: 'Respons√°vel', render: (r) => escapeHtml(r.responsibleName) },
                    { label: '√öltimo evento', render: (r) => escapeHtml(r.lastEvent || '-') },
                    { label: 'Status', render: (r) => renderStatus(r.status) },
                    { label: 'A√ß√µes', render: (r) => `
                        <div class="action-buttons">
                            <button class="btn-icon btn-approve" onclick="updateStatus('${r.id}', 'Concluido')" title="Concluir">‚úÖ</button>
                            <button class="btn-icon btn-view" onclick="viewDetails('${r.id}')" title="Ver logs">üßæ</button>
                        </div>
                    ` }
                ],
                empty: { title: 'Sem integra√ß√µes ativas', text: 'Nenhuma integra√ß√£o em andamento.' }
            },
            concluido: {
                title: 'Conclu√≠do',
                subtitle: 'Hist√≥rico de integra√ß√µes finalizadas',
                defaultStatus: 'Concluido',
                cards: (data) => [
                    { label: 'Conclu√≠das', value: data.length, icon: '‚úÖ' },
                    { label: 'Ativas em produ√ß√£o', value: data.filter(d => d.environment === 'Producao').length, icon: 'üöÄ' },
                    { label: '√öltimos 7 dias', value: data.filter(d => withinDays(d.concluidoAt, 7)).length, icon: 'üìÜ' },
                    { label: '√öltimos 30 dias', value: data.filter(d => withinDays(d.concluidoAt, 30)).length, icon: 'üóìÔ∏è' }
                ],
                filters: [
                    { id: 'gateway', label: 'Gateway', type: 'text', placeholder: 'Nome do gateway' },
                    { id: 'cliente', label: 'Cliente', type: 'text', placeholder: 'Nome do cliente' },
                    { id: 'date', label: 'Data conclus√£o', type: 'date' }
                ],
                columns: [
                    { label: 'ID', render: (r) => `<strong>${escapeHtml(r.id)}</strong>` },
                    { label: 'Gateway', render: (r) => escapeHtml(r.gatewayName) },
                    { label: 'Cliente', render: (r) => escapeHtml(r.clientName || r.whitelabelName || '-') },
                    { label: 'Tipo integra√ß√£o', render: (r) => escapeHtml(r.integrationType || '-') },
                    { label: 'Ambiente', render: (r) => escapeHtml(r.environment || '-') },
                    { label: 'Data conclus√£o', render: (r) => formatDate(r.concluidoAt) },
                    { label: 'SLA atendido', render: (r) => r.slaMet ? 'Sim' : 'N√£o' },
                    { label: 'A√ß√µes', render: (r) => `
                        <div class="action-buttons">
                            <button class="btn-icon btn-view" onclick="viewDetails('${r.id}')" title="Ver detalhes">üëÅÔ∏è</button>
                            <button class="btn-icon btn-approve" onclick="duplicateIntegration('${r.id}')" title="Duplicar">üìÑ</button>
                        </div>
                    ` }
                ],
                empty: { title: 'Nada conclu√≠do ainda', text: 'Integra√ß√µes conclu√≠das aparecer√£o aqui.' }
            },
            rejeitado: {
                title: 'Rejeitadas',
                subtitle: 'Governan√ßa e motivos de rejei√ß√£o',
                defaultStatus: 'Rejeitado',
                cards: (data) => [
                    { label: 'Rejeitadas', value: data.length, icon: '‚ùå' },
                    { label: 'Por compliance', value: data.filter(d => d.rejectionReason === 'compliance').length, icon: 'üõ°Ô∏è' },
                    { label: 'Por t√©cnica', value: data.filter(d => d.rejectionReason === 'tecnica').length, icon: 'üß©' },
                    { label: 'Por documenta√ß√£o', value: data.filter(d => d.rejectionReason === 'documentacao').length, icon: 'üìÑ' }
                ],
                filters: [
                    { id: 'motivo', label: 'Motivo', type: 'select', options: ['', 'documentacao', 'tecnica', 'compliance'] },
                    { id: 'gateway', label: 'Gateway', type: 'text', placeholder: 'Nome do gateway' },
                    { id: 'cliente', label: 'Cliente', type: 'text', placeholder: 'Nome do cliente' },
                    { id: 'date', label: 'Data', type: 'date' }
                ],
                columns: [
                    { label: 'ID', render: (r) => `<strong>${escapeHtml(r.id)}</strong>` },
                    { label: 'Gateway', render: (r) => escapeHtml(r.gatewayName) },
                    { label: 'Cliente', render: (r) => escapeHtml(r.clientName || r.whitelabelName || '-') },
                    { label: 'Motivo rejei√ß√£o', render: (r) => escapeHtml(r.rejectionReason || '-') },
                    { label: 'Respons√°vel decis√£o', render: (r) => escapeHtml(r.decisionBy || '-') },
                    { label: 'Data', render: (r) => formatDate(r.createdAt) },
                    { label: 'A√ß√µes', render: (r) => `
                        <div class="action-buttons">
                            <button class="btn-icon btn-view" onclick="viewDetails('${r.id}')" title="Ver">üëÅÔ∏è</button>
                            <button class="btn-icon btn-approve" onclick="reviewRequest('${r.id}')" title="Revisar">üîç</button>
                            <button class="btn-icon btn-approve" onclick="updateStatus('${r.id}', 'Pendente')" title="Reabrir">‚ôªÔ∏è</button>
                        </div>
                    ` }
                ],
                empty: { title: 'Nenhuma rejei√ß√£o', text: 'N√£o h√° solicita√ß√µes rejeitadas.' }
            },
            stats: {
                title: 'Estat√≠sticas',
                subtitle: 'Indicadores gerais do funil de integra√ß√µes',
                defaultStatus: '',
                cards: (data) => {
                    const total = data.length;
                    const approved = data.filter(d => ['Aguardando', 'Integrando', 'Concluido'].includes(d.status)).length;
                    const rate = total ? Math.round((approved / total) * 100) : 0;
                    const avg = calcAverageIntegrationTime(data);
                    const top = mostRequestedGateway(data);
                    const sla = calcSlaRate(data);
                    return [
                        { label: 'Taxa aprova√ß√£o', value: `${rate}%`, icon: '‚úÖ' },
                        { label: 'Tempo m√©dio integra√ß√£o', value: avg, icon: '‚è±Ô∏è' },
                        { label: 'Gateway mais solicitado', value: top || '-', icon: 'üí≥' },
                        { label: 'SLAs atendidos', value: sla, icon: 'üìà' }
                    ];
                },
                filters: [],
                columns: [
                    { label: 'Gateway', render: (r) => escapeHtml(r.gatewayName) },
                    { label: 'Solicita√ß√µes', render: (r) => r.total },
                    { label: 'Conclu√≠das', render: (r) => r.completed },
                    { label: 'Rejeitadas', render: (r) => r.rejected },
                    { label: 'Tempo m√©dio', render: (r) => r.avgTime },
                    { label: 'SLA%', render: (r) => r.slaRate }
                ],
                empty: { title: 'Sem dados', text: 'N√£o h√° dados suficientes para estat√≠sticas.' }
            },
            settings: {
                title: 'Configura√ß√µes',
                subtitle: 'Par√¢metros operacionais do CRM',
                defaultStatus: '',
                cards: (data) => [
                    { label: 'Gateways ativos', value: new Set(data.map(d => d.gatewayName)).size, icon: 'üí≥' },
                    { label: 'Motivos de rejei√ß√£o', value: settingsData.rejectionReasons.length, icon: '‚ùå' },
                    { label: 'Perfis', value: settingsData.roles.length, icon: 'üë§' },
                    { label: 'Templates', value: settingsData.templates.length, icon: '‚úâÔ∏è' }
                ],
                filters: [],
                columns: [],
                empty: { title: '', text: '' }
            }
        };

        window.addEventListener('load', function() {
            loadRequests();
        });

        async function fetchSubmissions(filters = {}) {
            const params = new URLSearchParams({
                page: '1',
                limit: '200',
                ...filters
            });
            const response = await fetch(`${apiBase}/submissions?${params.toString()}`);
            if (!response.ok) {
                throw new Error('Falha ao carregar dados.');
            }
            const data = await response.json();
            return data.items || [];
        }

        async function loadRequests() {
            try {
                allRequests = useMockData ? mockData : await fetchSubmissions();
                renderView(currentView);
            } catch (error) {
                console.error('Erro ao carregar solicita√ß√µes:', error);
                allRequests = [];
                renderView(currentView);
                showMessageModal('Erro', 'N√£o foi poss√≠vel carregar as solicita√ß√µes.');
            }
        }

        function renderView(viewKey) {
            const view = viewConfigs[viewKey];
            if (!view) return;

            document.querySelector('.header h1').textContent = view.title;
            document.querySelector('.header p').textContent = view.subtitle;

            renderCards(view, allRequests);
            renderFilters(view);

            const filtered = applyFilters(allRequests, view);
            document.getElementById('pendingCount').textContent = allRequests.filter(r => r.status === 'Pendente').length;

            if (viewKey === 'settings') {
                renderSettings();
                document.getElementById('tableContainer').style.display = 'none';
                document.getElementById('customContent').style.display = 'block';
                return;
            }

            document.getElementById('customContent').style.display = 'none';
            document.getElementById('tableContainer').style.display = 'block';

            if (viewKey === 'stats') {
                const summary = buildStatsSummary(allRequests);
                renderTable(view, summary);
                return;
            }

            renderTable(view, filtered);
        }

        function renderCards(view, data) {
            const cards = view.cards(data);
            const container = document.getElementById('statsGrid');
            container.innerHTML = cards.map(card => `
                <div class="stat-card">
                    <div class="stat-icon" style="background: rgba(181, 164, 114, 0.2);">
                        <span>${card.icon}</span>
                    </div>
                    <div class="stat-value">${card.value}</div>
                    <div class="stat-label">${card.label}</div>
                </div>
            `).join('');
        }

        function renderFilters(view) {
            const container = document.getElementById('filtersContainer');
            if (!view.filters.length) {
                container.style.display = 'none';
                container.innerHTML = '';
                currentFilters = {};
                return;
            }
            container.style.display = 'flex';
            container.innerHTML = view.filters.map(filter => {
                if (filter.type === 'select') {
                    const options = filter.options.map(opt => `
                        <option value="${opt}">${opt === '' ? 'Todos' : escapeHtml(formatStatus(opt))}</option>
                    `).join('');
                    return `
                        <div class="filter-item">
                            <label>${filter.label}</label>
                            <select data-filter="${filter.id}">
                                ${options}
                            </select>
                        </div>
                    `;
                }
                return `
                    <div class="filter-item">
                        <label>${filter.label}</label>
                        <input type="${filter.type}" data-filter="${filter.id}" placeholder="${filter.placeholder || ''}">
                    </div>
                `;
            }).join('');

            container.querySelectorAll('[data-filter]').forEach(el => {
                el.addEventListener('input', onFilterChange);
                el.addEventListener('change', onFilterChange);
            });

            if (!currentFilters || Object.keys(currentFilters).length === 0) {
                currentFilters = { status: view.defaultStatus || '' };
            }
            container.querySelectorAll('[data-filter]').forEach(el => {
                const key = el.dataset.filter;
                if (currentFilters[key]) {
                    el.value = currentFilters[key];
                } else if (key === 'status' && view.defaultStatus) {
                    el.value = view.defaultStatus;
                    currentFilters.status = view.defaultStatus;
                }
            });
        }

        function onFilterChange() {
            const container = document.getElementById('filtersContainer');
            currentFilters = {};
            container.querySelectorAll('[data-filter]').forEach(el => {
                currentFilters[el.dataset.filter] = el.value;
            });
            renderView(currentView);
        }

        function applyFilters(data, view) {
            let filtered = [...data];
            if (view.defaultStatus) {
                filtered = filtered.filter(item => item.status === view.defaultStatus);
            }
            const filters = currentFilters;
            if (filters.status) {
                filtered = filtered.filter(item => item.status === filters.status);
            }
            if (filters.search) {
                filtered = filtered.filter(item => matchesSearch(item, filters.search));
            }
            if (filters.gateway) {
                filtered = filtered.filter(item => includes(item.gatewayName, filters.gateway));
            }
            if (filters.cliente) {
                filtered = filtered.filter(item => includes(item.clientName || item.whitelabelName || '', filters.cliente));
            }
            if (filters.dev) {
                filtered = filtered.filter(item => includes(item.developerName, filters.dev));
            }
            if (filters.date) {
                filtered = filtered.filter(item => sameDate(item.createdAt, filters.date));
            }
            if (filters.motivo) {
                filtered = filtered.filter(item => (item.waitingReason || item.rejectionReason) === filters.motivo);
            }
            if (filters.etapa) {
                filtered = filtered.filter(item => item.stage === filters.etapa);
            }
            if (filters.ambiente) {
                filtered = filtered.filter(item => item.environment === filters.ambiente);
            }
            return filtered;
        }

        function renderTable(view, rows) {
            const thead = document.getElementById('tableHead');
            const tbody = document.getElementById('tableBody');
            const emptyState = document.getElementById('emptyState');

            if (!rows.length) {
                thead.innerHTML = '';
                tbody.innerHTML = '';
                emptyState.style.display = 'block';
                emptyState.querySelector('h3').textContent = view.empty.title;
                emptyState.querySelector('p').textContent = view.empty.text;
                return;
            }

            emptyState.style.display = 'none';
            thead.innerHTML = `
                <tr>
                    ${view.columns.map(col => `<th>${col.label}</th>`).join('')}
                </tr>
            `;
            tbody.innerHTML = rows.map(row => `
                <tr>
                    ${view.columns.map(col => `<td>${col.render(row)}</td>`).join('')}
                </tr>
            `).join('');
        }

        function setView(viewKey, el) {
            currentView = viewKey;
            currentFilters = {};
            setActiveNav(el);
            renderView(viewKey);
        }

        function setActiveNav(el) {
            document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));
            if (el) el.classList.add('active');
        }

        function renderStatus(status) {
            const statusClass = {
                'Pendente': 'status-pending',
                'Aguardando': 'status-pending',
                'Integrando': 'status-analyzing',
                'Concluido': 'status-approved',
                'Rejeitado': 'status-rejected'
            }[status] || 'status-pending';
            return `<span class="status-badge ${statusClass}">${escapeHtml(formatStatus(status))}</span>`;
        }

        function renderActions(req) {
            return `
                <div class="action-buttons">
                    <button class="btn-icon btn-view" onclick="viewDetails('${req.id}')" title="Ver Detalhes">üëÅÔ∏è</button>
                    ${req.status === 'Pendente' ? `
                        <button class="btn-icon btn-approve" onclick="updateStatus('${req.id}', 'Aguardando')" title="Aprovar">‚úÖ</button>
                        <button class="btn-icon btn-reject" onclick="updateStatus('${req.id}', 'Rejeitado')" title="Rejeitar">‚ùå</button>
                    ` : ''}
                    ${req.status === 'Aguardando' ? `
                        <button class="btn-icon btn-approve" onclick="updateStatus('${req.id}', 'Integrando')" title="Iniciar Integra√ß√£o">üõ†Ô∏è</button>
                    ` : ''}
                    ${req.status === 'Integrando' ? `
                        <button class="btn-icon btn-approve" onclick="updateStatus('${req.id}', 'Concluido')" title="Concluir">‚úÖ</button>
                    ` : ''}
                </div>
            `;
        }

        function renderSettings() {
            const container = document.getElementById('customContent');
            container.innerHTML = `
                <div class="section-card">
                    <h3>Status/Etapas do Fluxo</h3>
                    <table class="section-table">
                        <thead><tr><th>Status</th><th>Descri√ß√£o</th></tr></thead>
                        <tbody>
                            ${settingsData.statuses.map(s => `
                                <tr><td>${formatStatus(s)}</td><td>Etapa operacional</td></tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
                <div class="section-card">
                    <h3>Motivos de Rejei√ß√£o</h3>
                    <table class="section-table">
                        <thead><tr><th>Motivo</th><th>Categoria</th></tr></thead>
                        <tbody>
                            ${settingsData.rejectionReasons.map(r => `
                                <tr><td>${escapeHtml(r)}</td><td>Governan√ßa</td></tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
                <div class="section-card">
                    <h3>SLA por Tipo</h3>
                    <table class="section-table">
                        <thead><tr><th>Tipo</th><th>Horas</th></tr></thead>
                        <tbody>
                            ${settingsData.slas.map(s => `
                                <tr><td>${escapeHtml(s.tipo)}</td><td>${s.horas}h</td></tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
                <div class="section-card">
                    <h3>Pap√©is e Permiss√µes</h3>
                    <table class="section-table">
                        <thead><tr><th>Perfil</th><th>Descri√ß√£o</th></tr></thead>
                        <tbody>
                            ${settingsData.roles.map(r => `
                                <tr><td>${escapeHtml(r)}</td><td>Acesso padr√£o</td></tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
                <div class="section-card">
                    <h3>Templates de Comunica√ß√£o</h3>
                    <table class="section-table">
                        <thead><tr><th>Template</th><th>Status</th></tr></thead>
                        <tbody>
                            ${settingsData.templates.map(t => `
                                <tr><td>${escapeHtml(t)}</td><td>Ativo</td></tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
        }

        function buildStatsSummary(data) {
            const map = {};
            data.forEach(item => {
                if (!map[item.gatewayName]) {
                    map[item.gatewayName] = { gatewayName: item.gatewayName, total: 0, completed: 0, rejected: 0, avgTime: '0h', slaRate: '0%' };
                }
                map[item.gatewayName].total += 1;
                if (item.status === 'Concluido') map[item.gatewayName].completed += 1;
                if (item.status === 'Rejeitado') map[item.gatewayName].rejected += 1;
            });
            return Object.values(map).map(row => {
                const related = data.filter(d => d.gatewayName === row.gatewayName);
                row.avgTime = calcAverageIntegrationTime(related);
                row.slaRate = calcSlaRate(related);
                return row;
            });
        }

        function calcAverageIntegrationTime(data) {
            const durations = data
                .filter(r => r.integrandoAt && r.concluidoAt)
                .map(r => new Date(r.concluidoAt) - new Date(r.integrandoAt))
                .filter(ms => ms > 0);
            if (!durations.length) return '0h';
            const avgMs = durations.reduce((a, b) => a + b, 0) / durations.length;
            const hours = Math.round((avgMs / 3600000) * 10) / 10;
            return `${hours}h`;
        }

        function mostRequestedGateway(data) {
            const map = {};
            data.forEach(d => {
                map[d.gatewayName] = (map[d.gatewayName] || 0) + 1;
            });
            return Object.keys(map).sort((a, b) => map[b] - map[a])[0];
        }

        function calcSlaRate(data) {
            const completed = data.filter(d => d.status === 'Concluido');
            if (!completed.length) return '0%';
            const met = completed.filter(d => d.slaMet).length;
            return `${Math.round((met / completed.length) * 100)}%`;
        }

        function matchesSearch(item, term) {
            const t = term.toLowerCase();
            return [item.gatewayName, item.clientName, item.whitelabelName, item.responsibleName, item.developerName]
                .filter(Boolean)
                .some(v => v.toLowerCase().includes(t));
        }

        function includes(value, term) {
            return value && term ? value.toLowerCase().includes(term.toLowerCase()) : false;
        }

        function sameDate(dateValue, dateFilter) {
            if (!dateValue || !dateFilter) return true;
            return new Date(dateValue).toISOString().split('T')[0] === dateFilter;
        }

        function withinDays(dateValue, days) {
            if (!dateValue) return false;
            const diff = Date.now() - new Date(dateValue).getTime();
            return diff <= days * 86400000;
        }

        function isSlaRisk(limit) {
            if (!limit) return false;
            const diff = new Date(limit).getTime() - Date.now();
            return diff < 48 * 3600000 && diff > 0;
        }

        function formatDate(value) {
            if (!value) return '-';
            return new Date(value).toLocaleDateString('pt-BR');
        }

        function viewDetails(id) {
            const request = allRequests.find(r => r.id === id);
            if (!request) return;

            const modalBody = document.getElementById('modalBody');
            modalBody.innerHTML = `
                <div class="detail-section">
                    <h3>üí≥ Informa√ß√µes do Gateway</h3>
                    <div class="detail-grid">
                        <div class="detail-item">
                            <div class="detail-label">Nome do Gateway</div>
                            <div class="detail-value">${escapeHtml(request.gatewayName)}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Nome do Whitelabel</div>
                            <div class="detail-value">${escapeHtml(request.whitelabelName)}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Cliente/Parceiro</div>
                            <div class="detail-value">${escapeHtml(request.clientName || request.whitelabelName || '-')}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Status Atual</div>
                            <div class="detail-value">${escapeHtml(formatStatus(request.status))}</div>
                        </div>
                    </div>
                </div>

                <div class="detail-section">
                    <h3>üë§ Respons√°vel</h3>
                    <div class="detail-grid">
                        <div class="detail-item">
                            <div class="detail-label">Nome</div>
                            <div class="detail-value">${escapeHtml(request.responsibleName)}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">E-mail</div>
                            <div class="detail-value">${escapeHtml(request.responsibleEmail)}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Telefone</div>
                            <div class="detail-value">${escapeHtml(request.responsiblePhone)}</div>
                        </div>
                    </div>
                </div>

                <div class="detail-section">
                    <h3>üë®‚Äçüíª Desenvolvedor (Priorit√°rio)</h3>
                    <div class="detail-grid">
                        <div class="detail-item">
                            <div class="detail-label">Nome</div>
                            <div class="detail-value">${escapeHtml(request.developerName)}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">E-mail</div>
                            <div class="detail-value">${escapeHtml(request.developerEmail)}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Telefone</div>
                            <div class="detail-value">${escapeHtml(request.developerPhone)}</div>
                        </div>
                    </div>
                </div>

                <div class="detail-section">
                    <h3>üìå Opera√ß√£o</h3>
                    <div class="detail-grid">
                        <div class="detail-item">
                            <div class="detail-label">Motivo (Aguardando/Rejei√ß√£o)</div>
                            <div class="detail-value">${escapeHtml(request.waitingReason || request.rejectionReason || '-')}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Etapa</div>
                            <div class="detail-value">${escapeHtml(request.stage || '-')}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Ambiente</div>
                            <div class="detail-value">${escapeHtml(request.environment || '-')}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">√öltimo Evento</div>
                            <div class="detail-value">${escapeHtml(request.lastEvent || '-')}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">SLA Limite</div>
                            <div class="detail-value">${escapeHtml(formatDate(request.slaLimit))}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">SLA Atendido</div>
                            <div class="detail-value">${request.slaMet ? 'Sim' : 'N√£o'}</div>
                        </div>
                    </div>
                </div>

                <div class="detail-section">
                    <h3>‚è±Ô∏è Datas do Fluxo</h3>
                    <div class="detail-grid">
                        <div class="detail-item">
                            <div class="detail-label">Criado em</div>
                            <div class="detail-value">${escapeHtml(formatDate(request.createdAt))}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Aprovado em</div>
                            <div class="detail-value">${escapeHtml(formatDate(request.approvedAt))}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Integrando desde</div>
                            <div class="detail-value">${escapeHtml(formatDate(request.integrandoAt))}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Conclu√≠do em</div>
                            <div class="detail-value">${escapeHtml(formatDate(request.concluidoAt))}</div>
                        </div>
                    </div>
                </div>

                <div class="detail-section">
                    <h3>üîë Credenciais</h3>
                    <div class="detail-item">
                        <div class="detail-label">Chaves Sandbox</div>
                        <div class="detail-value" style="white-space: pre-wrap; font-family: monospace; font-size: 12px; background: rgba(0,0,0,0.3); padding: 10px; border-radius: 6px;">${escapeHtml(request.sandboxKeys)}</div>
                    </div>
                    ${request.productionAccount ? `
                        <div class="detail-item" style="margin-top: 15px;">
                            <div class="detail-label">Conta de Produ√ß√£o</div>
                            <div class="detail-value" style="white-space: pre-wrap; font-family: monospace; font-size: 12px; background: rgba(0,0,0,0.3); padding: 10px; border-radius: 6px;">${escapeHtml(request.productionAccount)}</div>
                        </div>
                    ` : ''}
                </div>

                <div style="display: flex; gap: 12px; margin-top: 30px;">
                    ${request.status === 'Pendente' ? `
                        <button class="btn btn-primary" style="flex: 1;" onclick="updateStatus('${request.id}', 'Aguardando'); closeModal();">
                            ‚úÖ Aprovar Integra√ß√£o
                        </button>
                        <button class="btn btn-secondary" style="flex: 1;" onclick="updateStatus('${request.id}', 'Rejeitado'); closeModal();">
                            ‚ùå Rejeitar
                        </button>
                    ` : request.status === 'Aguardando' ? `
                        <button class="btn btn-primary" style="flex: 1;" onclick="updateStatus('${request.id}', 'Integrando'); closeModal();">
                            üõ†Ô∏è Iniciar Integra√ß√£o
                        </button>
                        <button class="btn btn-secondary" style="flex: 1;" onclick="updateStatus('${request.id}', 'Rejeitado'); closeModal();">
                            ‚ùå Rejeitar
                        </button>
                    ` : request.status === 'Integrando' ? `
                        <button class="btn btn-primary" style="flex: 1;" onclick="updateStatus('${request.id}', 'Concluido'); closeModal();">
                            ‚úÖ Concluir
                        </button>
                    ` : `
                        <button class="btn btn-primary" style="flex: 1;" onclick="closeModal();">
                            Fechar
                        </button>
                    `}
                </div>
            `;

            document.getElementById('detailModal').classList.add('show');
        }

        function closeModal() {
            document.getElementById('detailModal').classList.remove('show');
        }

        function closeMessageModal() {
            document.getElementById('messageModal').classList.remove('show');
        }

        function showMessageModal(title, message) {
            document.getElementById('messageModalTitle').textContent = title;
            document.getElementById('messageModalBody').innerHTML = `<p>${escapeHtml(message)}</p>`;
            document.getElementById('messageModalActions').innerHTML = `
                <button class="btn btn-primary" onclick="closeMessageModal()">OK</button>
            `;
            document.getElementById('messageModal').classList.add('show');
        }

        function openRejectModal(onConfirm) {
            document.getElementById('messageModalTitle').textContent = 'Motivo da rejei√ß√£o';
            document.getElementById('messageModalBody').innerHTML = `
                <div class="form-group">
                    <label>Motivo <span class="required">*</span></label>
                    <select id="rejectReasonSelect">
                        <option value="">Selecione...</option>
                        <option value="COMPLIANCE">Compliance</option>
                        <option value="DOCUMENTACAO_INCOMPLETA">Documenta√ß√£o incompleta</option>
                        <option value="INCOMPATIVEL_TECNICAMENTE">Incompat√≠vel tecnicamente</option>
                        <option value="FORA_DE_ESCOPO">Fora de escopo</option>
                        <option value="DUPLICADA">Duplicada</option>
                        <option value="OUTRO">Outro</option>
                    </select>
                    <div class="modal-error" id="rejectReasonError" style="display:none;">Motivo obrigat√≥rio.</div>
                </div>
                <div class="form-group">
                    <label>Detalhes (opcional)</label>
                    <textarea id="rejectDetailsInput" rows="3" placeholder="Descreva o motivo se necess√°rio"></textarea>
                </div>
            `;
            document.getElementById('messageModalActions').innerHTML = `
                <button class="btn btn-secondary" onclick="closeMessageModal()">Cancelar</button>
                <button class="btn btn-primary" id="confirmRejectBtn">Confirmar</button>
            `;

            document.getElementById('messageModal').classList.add('show');

            document.getElementById('confirmRejectBtn').onclick = () => {
                const reason = document.getElementById('rejectReasonSelect').value;
                if (!reason) {
                    document.getElementById('rejectReasonError').style.display = 'block';
                    return;
                }
                const details = document.getElementById('rejectDetailsInput').value.trim() || null;
                closeMessageModal();
                onConfirm(reason, details);
            };
        }

        async function updateStatus(id, newStatus, rejectedReasonOverride, rejectedDetailsOverride) {
            try {
                let rejectedReason = rejectedReasonOverride;
                let rejectedDetails = rejectedDetailsOverride;
                if (newStatus === 'Rejeitado' && !rejectedReason) {
                    openRejectModal(async (reason, details) => {
                        await updateStatus(id, newStatus, reason, details);
                    });
                    return;
                }

                if (useMockData) {
                    const item = mockData.find(r => r.id === id);
                    if (item) {
                        item.status = newStatus;
                        if (newStatus === 'Aguardando') item.approvedAt = new Date().toISOString();
                        if (newStatus === 'Integrando') item.integrandoAt = new Date().toISOString();
                        if (newStatus === 'Concluido') item.concluidoAt = new Date().toISOString();
                        if (newStatus === 'Rejeitado') {
                            item.rejectionReason = rejectedReason;
                        }
                    }
                } else {
                    const response = await fetch(`${apiBase}/submissions/${id}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            status: newStatus,
                            rejectedReason,
                            rejectedDetails
                        })
                    });

                    const payload = await response.json().catch(() => ({}));
                    if (!response.ok) {
                        const details = Array.isArray(payload.errors) && payload.errors.length
                            ? payload.errors.map(e => {
                                const path = Array.isArray(e.path) && e.path.length ? e.path.join('.') : 'campo';
                                return `${path}: ${e.message}`;
                            }).join(' | ')
                            : (payload.message || 'Falha ao atualizar status.');
                        throw new Error(details);
                    }
                }

                await loadRequests();
                showMessageModal('Sucesso', `Solicita√ß√£o ${newStatus.toLowerCase()} com sucesso!`);
            } catch (error) {
                console.error('Erro ao atualizar status:', error);
                showMessageModal('Erro', error.message || 'N√£o foi poss√≠vel atualizar o status.');
            }
        }

        function requestAdjustment(id) {
            showMessageModal('Ajuste solicitado', `Solicita√ß√£o ${id}: ajuste solicitado ao cliente.`);
        }

        function duplicateIntegration(id) {
            showMessageModal('Duplica√ß√£o', `Solicita√ß√£o ${id}: duplica√ß√£o iniciada.`);
        }

        function reviewRequest(id) {
            showMessageModal('Revis√£o', `Solicita√ß√£o ${id}: revis√£o em andamento.`);
        }

        async function refreshData() {
            await loadRequests();
            showMessageModal('Atualiza√ß√£o', 'Dados atualizados!');
        }

        function exportData() {
            const view = viewConfigs[currentView];
            const rows = currentView === 'stats' ? buildStatsSummary(allRequests) : applyFilters(allRequests, view);
            const headers = view.columns.map(c => c.label);
            const dataRows = rows.map(row => view.columns.map(c => stripHtml(c.render(row))));
            const csv = [headers, ...dataRows].map(row => row.join(',')).join('\n');

            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `pegasus_${currentView}_${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
        }

        function stripHtml(html) {
            return html.replace(/<[^>]*>/g, '').replace(/\s+/g, ' ').trim();
        }

        // Close modal on outside click
        document.getElementById('detailModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeModal();
            }
        });
    </script>
</body>
</html>
